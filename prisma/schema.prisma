generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id                String            @id @default(uuid())
  username          String            @unique
  password          String
  role              UserRole
  departmentId      String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  attendanceEntries AttendanceEntry[]
  department        Department?       @relation(fields: [departmentId], references: [id])
}

model SystemSetting {
  id        String   @id @default(uuid())
  key       String   @unique
  value     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Department {
  id                String            @id @default(uuid())
  name              String            @unique
  description       String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  attendanceEntries AttendanceEntry[]
  employees         Employee[]
  users             User[]
}

model Employee {
  id                String                     @id @default(uuid())
  empCode           String                     @unique
  name              String
  pfId              String?                    @unique
  esicId            String?                    @unique
  aadhaarNumber     String                     @unique
  mobile            String
  hourlyRate        Float
  profileComplete   Boolean                    @default(false)
  departmentId      String
  createdAt         DateTime                   @default(now())
  updatedAt         DateTime                   @updatedAt
  shiftTypeId       String?
  bankAccountNumber String?
  currentAddress    String?
  cycleTimingId     String?
  dob               DateTime?
  esicActive        Boolean                    @default(true)
  ifscCode          String?
  panNumber         String?                    @unique
  permanentAddress  String?
  pfActive          Boolean                    @default(true)
  joinedAt          DateTime
  pfAmountPerDay    Float?                     @default(0)
  attendanceWallet  AttendanceWallet?
  cycleTiming       CycleTiming?               @relation(fields: [cycleTimingId], references: [id])
  department        Department                 @relation(fields: [departmentId], references: [id])
  shiftType         ShiftType?                 @relation(fields: [shiftTypeId], references: [id])
  monthlySummaries  MonthlyAttendanceSummary[]
}

model CycleTiming {
  id          String     @id @default(uuid())
  name        String
  startDay    Int
  description String?
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  span        CycleSpan
  endDay      Int
  employees   Employee[]
}

model MonthlyAttendanceSummary {
  id            String   @id @default(uuid())
  employeeId    String
  cycleStart    DateTime
  cycleEnd      DateTime
  daysInCycle   Int
  daysPresent   Int
  totalHours    Float
  hourlyRate    Float
  deductions    Json     @default("{\"shoes\": 0, \"canteen\": 0}")
  netSalary     Float
  generatedAt   DateTime @default(now())
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  advanceAmount Float    @default(0)
  daysAbsent    Int
  overtimeHours Float    @default(0)
  employee      Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  @@unique([employeeId, cycleStart])
}

model AttendanceEntry {
  id           String           @id @default(uuid())
  timestamp    DateTime         @default(now())
  scanType     ScanType
  departmentId String
  scannedBy    String
  walletId     String
  autoClosed   Boolean          @default(false)
  department   Department       @relation(fields: [departmentId], references: [id])
  user         User             @relation(fields: [scannedBy], references: [id])
  wallet       AttendanceWallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  @@index([walletId])
  @@index([timestamp])
  @@index([walletId, timestamp])
}

model AttendanceWallet {
  id         String            @id @default(uuid())
  employeeId String            @unique
  createdAt  DateTime          @default(now())
  updatedAt  DateTime          @updatedAt
  entries    AttendanceEntry[]
  employee   Employee          @relation(fields: [employeeId], references: [id], onDelete: Cascade)
}

model ShiftType {
  id         String     @id @default(uuid())
  name       String     @unique
  startTime  DateTime
  endTime    DateTime
  totalHours Float
  createdAt  DateTime   @default(now())
  updatedAt  DateTime   @updatedAt
  employees  Employee[]
}

enum UserRole {
  admin
  supervisor
}

enum CycleSpan {
  SAME_MONTH
  NEXT_MONTH
}

enum ScanType {
  in
  out
}
