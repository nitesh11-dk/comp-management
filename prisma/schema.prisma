generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

//
// ---------------------- USER ----------------------
//

enum UserRole {
  admin
  supervisor
}

model User {
  id           String      @id @default(uuid())
  username     String      @unique
  password     String
  role         UserRole
  departmentId String?
  department   Department? @relation(fields: [departmentId], references: [id])

  attendanceEntries AttendanceEntry[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model SystemSetting {
  id    String @id @default(uuid())
  key   String @unique
  value Json

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//
// ---------------------- DEPARTMENT ----------------------
//

model Department {
  id          String     @id @default(uuid())
  name        String     @unique
  description String?

  users         User[]
  employees     Employee[]
  attendanceEntries AttendanceEntry[]

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

//
// ---------------------- EMPLOYEE ----------------------
//

model Employee {
  id             String       @id @default(uuid())
  empCode        String       @unique
  name           String

  pfId           String?      @unique
  pfActive       Boolean      @default(true)

  // âœ… NEW FIELD
  pfAmountPerDay Float?       @default(0)

  esicId         String?      @unique
  esicActive     Boolean      @default(true)

  aadhaarNumber  String       @unique
  panNumber      String?      @unique
  dob            DateTime?
  mobile         String

  currentAddress   String?
  permanentAddress String?

  bankAccountNumber String?
  ifscCode          String?

  hourlyRate      Float
  profileComplete Boolean @default(false)

  departmentId String
  department   Department @relation(fields: [departmentId], references: [id])

  shiftTypeId   String?
  shiftType     ShiftType? @relation(fields: [shiftTypeId], references: [id])

  cycleTimingId String?
  cycleTiming   CycleTiming? @relation(fields: [cycleTimingId], references: [id])

  attendanceWallet AttendanceWallet?
  monthlySummaries MonthlyAttendanceSummary[]

  joinedAt DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//
// ---------------------- CYCLE TIMING ----------------------
//

model CycleTiming {
  id          String   @id @default(uuid())
  name        String
  startDay    Int      // 1..28
  lengthDays  Int      @default(30)
  description String?

  employees   Employee[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

//
// ---------------------- MONTHLY SUMMARY ----------------------
//

model MonthlyAttendanceSummary {
  id            String   @id @default(uuid())

  employeeId    String
  employee      Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  cycleStart    DateTime
  cycleEnd      DateTime

  daysInCycle   Int
  daysPresent   Int
  daysAbsent    Int

  totalHours    Float
  overtimeHours Float    @default(0)

  hourlyRate    Float

  advanceAmount Float    @default(0)

  // Default deductions structure:
  // { "shoes": 0, "canteen": 0 }
  deductions    Json     @default("{\"shoes\":0,\"canteen\":0}")

  netSalary     Float

  generatedAt   DateTime @default(now())

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([employeeId, cycleStart])
}



//
// ---------------------- ATTENDANCE ENTRY ----------------------
//

enum ScanType {
  in
  out
}

model AttendanceEntry {
  id            String    @id @default(uuid())
  timestamp     DateTime  @default(now())
  scanType      ScanType

  departmentId  String
  department    Department @relation(fields: [departmentId], references: [id])

  scannedBy     String
  user          User @relation(fields: [scannedBy], references: [id])

  walletId      String
  wallet        AttendanceWallet @relation(fields: [walletId], references: [id], onDelete: Cascade)

  autoClosed    Boolean   @default(false)

  @@index([walletId])
  @@index([timestamp])
  @@index([walletId, timestamp])
}

//
// ---------------------- ATTENDANCE WALLET ----------------------
//

model AttendanceWallet {
  id         String   @id @default(uuid())
  employeeId String   @unique
  employee   Employee @relation(fields: [employeeId], references: [id], onDelete: Cascade)

  entries    AttendanceEntry[]

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt
}

//
// ---------------------- SHIFT TYPE ----------------------
//

model ShiftType {
  id          String    @id @default(uuid())
  name        String    @unique

  startTime   DateTime
  endTime     DateTime

  totalHours  Float

  employees   Employee[]

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
